     cars.forEach(car => {
          createCarElement(car);
        });
      } catch (error) {
        console.error("車両データの読み込みエラー:", error);
        carListDiv.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--danger-color);">
            <p>データの読み込みに失敗しました</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">
              ページを更新してもう一度お試しください
            </p>
          </div>
        `;
      } finally {
        hideLoader();
      }
      }
    }

    // 車両要素を作成する
    function createCarElement(car) {
      const carDiv = document.createElement("div");
      carDiv.className = "car-item";
      carDiv.id = car.id;
      carDiv.setAttribute("data-status", car.status);

      // タイヤタイプがなければノーマルタイヤをデフォルトに設定
      const tireType = car.tireType || "normal";

      // 管理番号があれば [管理番号] を付加して表示
      carDiv.innerHTML = `
        <div class="car-status" data-status="${car.status}">${car.status}</div>
        <div class="car-name">
          ${car.managementNumber ? `[${car.managementNumber}] ` : ""}${car.name}
          <span class="car-class">${car.class}</span>
        </div>
        <div class="car-features">
          <div class="car-feature ${car.etc ? 'active' : ''}">ETC</div>
          <div class="car-feature ${car.nav ? 'active' : ''}">ナビ</div>
          <div class="car-feature ${car.fourwd ? 'active' : ''}">4WD</div>
          <div class="tire-toggle ${tireType === 'studless' ? 'studless' : ''}" data-car-id="${car.id}" data-tire-type="${tireType}">
            ${tireType === 'studless' ? 'スタッドレスタイヤ' : 'ノーマルタイヤ'}
          </div>
        </div>
        ${car.remarks ? `<div class="car-remarks">備考: ${car.remarks}</div>` : ''}
        <button class="status-toggle" data-car-id="${car.id}">状態変更</button>
      `;

      // 状態変更ボタンのイベントリスナー
      const statusToggle = carDiv.querySelector('.status-toggle');
      statusToggle.addEventListener('click', (e) => {
        e.stopPropagation(); // イベントの伝播を停止
        
        const currentIndex = statuses.indexOf(car.status);
        const nextIndex = (currentIndex + 1) % statuses.length;
        const newStatus = statuses[nextIndex];
        
        showLoader();
        updateDoc(doc(db, "cars", car.id), { status: newStatus })
          .then(() => loadCars())
          .catch(error => {
            console.error("状態更新エラー:", error);
            alert("状態の更新に失敗しました。もう一度お試しください。");
            hideLoader();
          });
      });

      // タイヤ切り替えのイベントリスナー
      const tireToggle = carDiv.querySelector('.tire-toggle');
      tireToggle.addEventListener('click', async (e) => {
        e.stopPropagation(); // イベントの伝播を停止
        
        const currentType = tireToggle.getAttribute('data-tire-type');
        const newType = currentType === 'normal' ? 'studless' : 'normal';
        
        showLoader();
        try {
          await updateDoc(doc(db, "cars", car.id), { tireType: newType });
          tireToggle.setAttribute('data-tire-type', newType);
          tireToggle.textContent = newType === 'studless' ? 'スタッドレスタイヤ' : 'ノーマルタイヤ';
          tireToggle.classList.toggle('studless', newType === 'studless');
          hideLoader();
        } catch (error) {
          console.error("タイヤ種類更新エラー:", error);
          alert("タイヤ種類の更新に失敗しました。もう一度お試しください。");
          hideLoader();
        }
      });

      // 削除ボタン
      const deleteButton = document.createElement("button");
      deleteButton.innerHTML = "✕";
      deleteButton.className = "delete-button";
      deleteButton.addEventListener("click", (e) => {
        e.stopPropagation(); // イベントの伝播を停止
        
        // 削除確認ダイアログを表示
        carToDelete = car;
        deleteMessage.textContent = `${car.name}を削除してもよろしいですか？`;
        deleteConfirm.style.display = "flex";
      });
      carDiv.appendChild(deleteButton);

      // 長押しで詳細編集
      let pressTimer;
      let longPressTriggered = false;
      const longPressThreshold = 800; // 800msで長押しと判定

      const triggerLongPress = () => {
        longPressTriggered = true;
        longPressIndicator.classList.remove("active");
        showEditModal(car);
      };

      // タッチイベント（スマホ向け）
      carDiv.addEventListener("touchstart", (e) => {
        // 状態変更ボタンやタイヤ切り替えボタン、削除ボタンからの長押しは無視
        if (e.target.closest('.status-toggle') || e.target.closest('.tire-toggle') || e.target.closest('.delete-button')) {
          return;
        }
        
        longPressTriggered = false;
        pressTimer = setTimeout(() => {
          longPressIndicator.classList.add("active");
          pressTimer = setTimeout(() => {
            triggerLongPress();
          }, 300);
        }, 400);
      });

      carDiv.addEventListener("touchend", (e) => {
        // 状態変更ボタンやタイヤ切り替えボタン、削除ボタンからのタッチは無視
        if (e.target.closest('.status-toggle') || e.target.closest('.tire-toggle') || e.target.closest('.delete-button')) {
          return;
        }
        
        clearTimeout(pressTimer);
        longPressIndicator.classList.remove("active");
      });

      carDiv.addEventListener("touchmove", (e) => {
        clearTimeout(pressTimer);
        longPressIndicator.classList.remove("active");
      });

      // マウスイベント（PC向け）
      carDiv.addEventListener("mousedown", (e) => {
        // 状態変更ボタンやタイヤ切り替えボタン、削除ボタンからの長押しは無視
        if (e.target.closest('.status-toggle') || e.target.closest('.tire-toggle') || e.target.closest('.delete-button')) {
          return;
        }
        
        longPressTriggered = false;
        pressTimer = setTimeout(() => {
          longPressIndicator.classList.add("active");
          pressTimer = setTimeout(() => {
            triggerLongPress();
          }, 300);
        }, 400);
      });

      carDiv.addEventListener("mouseup", (e) => {
        // 状態変更ボタンやタイヤ切り替えボタン、削除ボタンからのクリックは無視
        if (e.target.closest('.status-toggle') || e.target.closest('.tire-toggle') || e.target.closest('.delete-button')) {
          return;
        }
        
        clearTimeout(pressTimer);
        longPressIndicator.classList.remove("active");
      });

      carDiv.addEventListener("mouseleave", (e) => {
        clearTimeout(pressTimer);
        longPressIndicator.classList.remove("active");
      });

      carListDiv.appendChild(carDiv);
    }

    // 編集モーダルを表示
    function showEditModal(car) {
      document.getElementById("edit-car-id").value = car.id;
      document.getElementById("edit-management-number").value = car.managementNumber || "";
      document.getElementById("edit-car-name").value = car.name;
      document.getElementById("edit-car-class").value = car.class;
      document.getElementById("edit-car-remarks").value = car.remarks || "";
      document.getElementById("edit-car-etc").checked = car.etc || false;
      document.getElementById("edit-car-nav").checked = car.nav || false;
      document.getElementById("edit-car-4wd").checked = car.fourwd || false;
      
      // タイヤ種類の設定
      const tireType = car.tireType || "normal";
      if (tireType === "studless") {
        document.getElementById("edit-car-studless-tire").checked = true;
      } else {
        document.getElementById("edit-car-normal-tire").checked = true;
      }

      editCarModal.style.display = "block";
    }

    // フィルタータブの切り替え - 複数選択対応版
    filterTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const filter = tab.getAttribute("data-filter");
        
        // すべてタブの処理
        if (filter === "all") {
          // すべてタブがクリックされたら他のすべてのフィルターをクリア
          filterTabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          selectedFilters = ["all"];
          loadCars();
          return;
        }
        
        // すでに選択されているタブをクリックした場合（選択解除）
        if (tab.classList.contains("active")) {
          tab.classList.remove("active");
          selectedFilters = selectedFilters.filter(f => f !== filter);
          
          // すべてのフィルターが解除された場合は「すべて」を選択状態に
          if (selectedFilters.length === 0) {
            filterTabs[0].classList.add("active");
            selectedFilters = ["all"];
          }
        } else {
          // 新しいタブを選択した場合
          tab.classList.add("active");
          
          // 「すべて」タブが選択されていれば解除
          if (selectedFilters.includes("all")) {
            filterTabs[0].classList.remove("active");
            selectedFilters = [filter];
          } else {
            // 他のフィルターに追加
            selectedFilters.push(filter);
          }
        }
        
        loadCars();
      });
    });

    // 初期読み込み
    loadCars();

    // 新規追加モーダルの表示・非表示制御
    addCarButton.addEventListener("click", () => {
      addCarModal.style.display = "block";
    });

    closeModalButton.addEventListener("click", () => {
      addCarModal.style.display = "none";
    });

    closeEditModalButton.addEventListener("click", () => {
      editCarModal.style.display = "none";
    });

    // モーダル外クリックで閉じる
    window.addEventListener("click", (e) => {
      if (e.target === addCarModal) {
        addCarModal.style.display = "none";
      }
      if (e.target === editCarModal) {
        editCarModal.style.display = "none";
      }
      if (e.target === deleteConfirm) {
        deleteConfirm.style.display = "none";
      }
    });

    // 削除確認ダイアログのボタン
    cancelDelete.addEventListener("click", () => {
      deleteConfirm.style.display = "none";
      carToDelete = null;
    });

    confirmDelete.addEventListener("click", async () => {
      if (!carToDelete) return;
      
      deleteConfirm.style.display = "none";
      showLoader();
      
      try {
        await deleteDoc(doc(db, "cars", carToDelete.id));
        loadCars();
      } catch (error) {
        console.error("削除エラー:", error);
        alert("削除に失敗しました。もう一度お試しください。");
        hideLoader();
      } finally {
        carToDelete = null;
      }
    });

    // 新規車両追加フォームの送信処理
    document.getElementById("add-car-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const managementNumber = document.getElementById("management-number").value;
      const name = document.getElementById("car-name").value;
      const carClass = document.getElementById("car-class").value;
      const status = document.getElementById("car-status").value;
      const remarks = document.getElementById("car-remarks").value;
      const etc = document.getElementById("car-etc").checked;
      const nav = document.getElementById("car-nav").checked;
      const fourwd = document.getElementById("car-4wd").checked;
      const tireType = document.querySelector('input[name="tire-type"]:checked').value;

      showLoader();
      try {
        await addDoc(collection(db, "cars"), {
          managementNumber,
          name,
          class: carClass,
          status,
          remarks,
          etc,
          nav,
          fourwd,
          tireType
        });

        e.target.reset();
        addCarModal.style.display = "none";
        loadCars();
      } catch (error) {
        console.error("車両追加エラー:", error);
        alert("車両の追加に失敗しました。もう一度お試しください。");
        hideLoader();
      }
    });

    // 車両編集フォームの送信処理
    document.getElementById("edit-car-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const carId = document.getElementById("edit-car-id").value;
      const managementNumber = document.getElementById("edit-management-number").value;
      const name = document.getElementById("edit-car-name").value;
      const carClass = document.getElementById("edit-car-class").value;
      const remarks = document.getElementById("edit-car-remarks").value;
      const etc = document.getElementById("edit-car-etc").checked;
      const nav = document.getElementById("edit-car-nav").checked;
      const fourwd = document.getElementById("edit-car-4wd").checked;
      const tireType = document.querySelector('input[name="edit-tire-type"]:checked').value;

      showLoader();
      try {
        await updateDoc(doc(db, "cars", carId), {
          managementNumber,
          name,
          class: carClass,
          remarks,
          etc,
          nav,
          fourwd,
          tireType
        });

        editCarModal.style.display = "none";
        loadCars();
      } catch (error) {
        console.error("車両更新エラー:", error);
        alert("車両情報の更新に失敗しました。もう一度お試しください。");
        hideLoader();
      }
    });

    // エラーハンドリング：Firebaseへの接続エラーを表示
    window.addEventListener("error", (e) => {
      if (e.message.includes("Firebase") || e.message.includes("firestore")) {
        console.error("Firebase接続エラー:", e);
        alert("データベース接続に問題が発生しました。インターネット接続を確認してください。");
      }
    });

    // オフライン検出
    window.addEventListener("offline", () => {
      alert("インターネット接続が切断されました。接続が回復するまでデータは保存されません。");
    });

    // スマホでのスクロール改善（iOS対応）
    document.addEventListener('touchmove', function(e) {
      if (e.target.closest('#add-car-modal .modal-content') ||
          e.target.closest('#edit-car-modal .modal-content') ||
          e.target.closest('#delete-confirm .confirm-content')) {
        e.stopPropagation();
      }
    }, { passive: false });
  </script>
</body>
</html>
